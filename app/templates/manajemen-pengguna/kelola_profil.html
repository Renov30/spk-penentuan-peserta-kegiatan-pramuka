<div
  x-show="page === 'profil'"
  x-cloak
  x-data="pesertaProfilData()"
  x-init="loadPesertaList()"
  x-transition:enter="transition ease-out duration-500"
  x-transition:enter-start="opacity-0 translate-y-4"
  x-transition:enter-end="opacity-100 translate-y-0"
  x-transition:leave="transition ease-in duration-300"
  x-transition:leave-start="opacity-100 translate-y-0"
  x-transition:leave-end="opacity-0 translate-y-4"
  class="p-8 rounded-2xl shadow-xl w-full border border-gray-200 dark:border-gray-700 {{ 'bg-gray-800 text-gray-100' if current_theme == 'dark' else 'bg-white text-gray-800 dark:bg-gray-100' }}"
>
  <!-- Header -->
  <div class="flex items-center justify-between border-b pb-4 mb-8">
    <div>
      <h2 class="text-3xl font-semibold flex items-center gap-3">
        <i class="fa-solid fa-id-card text-teal-500 text-4xl"></i>
        {{ 'Profil Peserta' if current_lang == 'id' else 'Participant Profile'
        }}
      </h2>
      <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
        {{ 'Kelola data peserta yang terdaftar di sistem' if current_lang ==
        'id' else 'Manage participant data registered in the system' }}
      </p>
    </div>

    <button
      @click="page = 'main'; if ($store.page) $store.page.breadcrumbs = current_lang === 'id' ? ['Manajemen Pengguna'] : ['Users Management']"
      class="px-2 py-2 rounded-lg cursor-pointer {{ 'bg-gray-300 hover:bg-gray-900 dark:bg-gray-700' if current_theme == 'dark' else 'bg-gray-200 hover:bg-gray-500 dark:bg-gray-400' }}"
    >
      <i class="fa-solid fa-backward"></i>
      {{ 'Kembali' if current_lang == 'id' else 'Back' }}
    </button>
  </div>

  <!-- Toolbar: Search, Filter, Tambah -->
  <div
    class="mb-6 {{ 'bg-gray-800' if current_theme == 'dark' else 'bg-gray-50' }} p-4 rounded-lg border {{ 'border-gray-700' if current_theme == 'dark' else 'border-gray-200' }}"
  >
    <!-- Search Bar - Full Width -->
    <div class="mb-3">
      <div class="relative">
        <input
          type="text"
          x-model="searchQuery"
          @input="filterPeserta()"
          @keyup.enter="filterPeserta()"
          placeholder="{{ 'Cari nama, email, atau username...' if current_lang == 'id' else 'Search name, email, or username...' }}"
          class="w-full pl-4 pr-14 py-2.5 rounded-lg border-2 text-sm {{ 'border-gray-600 bg-gray-700 text-white placeholder-gray-400' if current_theme == 'dark' else 'border-gray-300 bg-white text-gray-900 placeholder-gray-500' }} focus:outline-none focus:border-teal-500 focus:ring-2 focus:ring-teal-400 transition shadow-sm"
        />
        <div
          class="absolute inset-y-0 right-4 flex items-center pointer-events-none z-10"
        >
          <i
            class="fa-solid fa-search {{ 'text-gray-400' if current_theme == 'dark' else 'text-gray-500' }}"
          ></i>
        </div>
      </div>
    </div>

    <!-- Filter & Action Row -->
    <div class="flex flex-col md:flex-row gap-3 items-center">
      <!-- Filter Golongan -->
      <div class="w-full md:w-48 flex-shrink-0">
        <select
          x-model="filterGolongan"
          @change="filterPeserta()"
          class="w-full px-3 py-2.5 rounded-lg border-2 text-sm {{ 'border-gray-600 bg-gray-700 text-white' if current_theme == 'dark' else 'border-gray-300 bg-white text-gray-900' }} focus:outline-none focus:border-teal-500 focus:ring-2 focus:ring-teal-400 transition shadow-sm"
        >
          <option value="">
            {{ 'Semua Golongan' if current_lang == 'id' else 'All Groups' }}
          </option>
          <option value="siaga">Siaga</option>
          <option value="penggalang">Penggalang</option>
          <option value="penegak">Penegak</option>
          <option value="pandega">Pandega</option>
        </select>
      </div>

      <!-- Filter Status -->
      <div class="w-full md:w-48 flex-shrink-0">
        <select
          x-model="filterStatus"
          @change="filterPeserta()"
          class="w-full px-3 py-2.5 rounded-lg border-2 text-sm {{ 'border-gray-600 bg-gray-700 text-white' if current_theme == 'dark' else 'border-gray-300 bg-white text-gray-900' }} focus:outline-none focus:border-teal-500 focus:ring-2 focus:ring-teal-400 transition shadow-sm"
        >
          <option value="">
            {{ 'Semua Status' if current_lang == 'id' else 'All Status' }}
          </option>
          <option value="aktif">
            {{ 'Aktif' if current_lang == 'id' else 'Active' }}
          </option>
          <option value="non-aktif">
            {{ 'Nonaktif' if current_lang == 'id' else 'Inactive' }}
          </option>
        </select>
      </div>

      <!-- Tombol Tambah -->
      <div class="w-full md:w-auto flex-shrink-0 md:ml-auto">
        <button
          @click="selectedPeserta = {nama_lengkap: '', username: '', email: '', jenis_kelamin: '', usia: '', nomor_hp: '', golongan: '', tingkatan: '', tanggal_lahir: '', alamat_tinggal: '', asal_gudep: '', asal_kwarran: '', asal_kwarcab: '', asal_kwarda: '', status: 'aktif'}; showAddModal = true; showEditModal = false"
          class="w-full md:w-auto px-5 py-2.5 rounded-lg bg-teal-600 text-white hover:bg-teal-700 transition cursor-pointer whitespace-nowrap text-sm font-medium shadow-md hover:shadow-lg"
        >
          <i class="fa-solid fa-plus mr-2"></i>
          {{ 'Tambah Peserta' if current_lang == 'id' else 'Add Participant' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Tabel Data Peserta -->
  <div
    class="overflow-x-auto rounded-lg border {{ 'border-gray-600' if current_theme == 'dark' else 'border-gray-300' }}"
  >
    <table class="w-full text-sm">
      <thead
        class="{{ 'bg-gray-700 text-white' if current_theme == 'dark' else 'bg-gray-100 text-gray-900' }}"
      >
        <tr>
          <th class="px-4 py-3 text-left font-semibold">No.</th>
          <th class="px-4 py-3 text-left font-semibold">
            {{ 'Foto' if current_lang == 'id' else 'Photo' }}
          </th>
          <th class="px-4 py-3 text-left font-semibold">
            {{ 'Nama Lengkap' if current_lang == 'id' else 'Full Name' }}
          </th>
          <th class="px-4 py-3 text-left font-semibold">
            {{ 'Username' if current_lang == 'id' else 'Username' }}
          </th>
          <th class="px-4 py-3 text-left font-semibold">
            {{ 'Email' if current_lang == 'id' else 'Email' }}
          </th>
          <th class="px-4 py-3 text-left font-semibold">
            {{ 'Jenis Kelamin' if current_lang == 'id' else 'Gender' }}
          </th>
          <th class="px-4 py-3 text-left font-semibold">
            {{ 'Usia' if current_lang == 'id' else 'Age' }}
          </th>
          <th class="px-4 py-3 text-left font-semibold">
            {{ 'Golongan' if current_lang == 'id' else 'Group' }}
          </th>
          <th class="px-4 py-3 text-left font-semibold">
            {{ 'Tingkatan' if current_lang == 'id' else 'Level' }}
          </th>
          <th class="px-4 py-3 text-left font-semibold">
            {{ 'Nomor HP' if current_lang == 'id' else 'Phone' }}
          </th>
          <th class="px-4 py-3 text-left font-semibold">
            {{ 'Status' if current_lang == 'id' else 'Status' }}
          </th>
          <th class="px-4 py-3 text-left font-semibold">
            {{ 'Aksi' if current_lang == 'id' else 'Actions' }}
          </th>
        </tr>
      </thead>
      <tbody>
        <template
          x-for="(peserta, index) in paginatedPeserta"
          :key="peserta.id"
        >
          <tr
            class="border-b {{ 'border-gray-700 hover:bg-gray-800' if current_theme == 'dark' else 'border-gray-200 hover:bg-gray-50' }}"
          >
            <td
              class="px-4 py-3"
              x-text="(currentPage - 1) * itemsPerPage + index + 1"
            ></td>
            <td class="px-4 py-3">
              <img
                :src="peserta.foto && peserta.foto !== 'img/default-user.png' && peserta.foto !== '' ? `{{ url_for('static', filename='') }}${peserta.foto}` : '{{ url_for('static', filename='images/profil-default.jpg') }}'"
                alt="Foto"
                class="w-6 h-6 rounded-full object-cover border {{ 'border-teal-500' if current_theme == 'dark' else 'border-teal-400' }}"
                @error="$el.src='{{ url_for('static', filename='images/profil-default.jpg') }}'"
              />
            </td>
            <td
              class="px-4 py-3 font-medium"
              x-text="peserta.nama_lengkap || '-'"
            ></td>
            <td class="px-4 py-3" x-text="peserta.username || '-'"></td>
            <td class="px-4 py-3" x-text="peserta.email || '-'"></td>
            <td class="px-4 py-3" x-text="peserta.jenis_kelamin || '-'"></td>
            <td class="px-4 py-3" x-text="peserta.usia || '-'"></td>
            <td class="px-4 py-3" x-text="peserta.golongan || '-'"></td>
            <td class="px-4 py-3" x-text="peserta.tingkatan || '-'"></td>
            <td class="px-4 py-3" x-text="peserta.nomor_hp || '-'"></td>
            <td class="px-4 py-3">
              <span
                class="px-2 py-1 text-xs rounded-lg font-medium"
                :class="peserta.status === 'aktif' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'"
                x-text="peserta.status || '-'"
              ></span>
            </td>
            <td class="px-4 py-3">
              <div class="flex gap-2">
                <button
                  @click="editPeserta(peserta)"
                  class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-xs cursor-pointer transition"
                  title="{{ 'Edit' if current_lang == 'id' else 'Edit' }}"
                >
                  <i class="fa-solid fa-pen-to-square"></i>
                </button>
                <button
                  @click="confirmDelete(peserta)"
                  class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded-lg text-xs cursor-pointer transition"
                  title="{{ 'Hapus' if current_lang == 'id' else 'Delete' }}"
                >
                  <i class="fa-solid fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        </template>
        <tr x-show="filteredPeserta.length === 0">
          <td
            colspan="12"
            class="px-4 py-8 text-center {{ 'text-gray-400' if current_theme == 'dark' else 'text-gray-500' }}"
          >
            <i class="fa-solid fa-inbox text-4xl mb-2"></i>
            <p>
              {{ 'Tidak ada data peserta' if current_lang == 'id' else 'No
              participant data' }}
            </p>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div
    class="mt-6 flex justify-between items-center"
    x-show="filteredPeserta.length > 0"
  >
    <span
      class="text-sm {{ 'text-gray-400' if current_theme == 'dark' else 'text-gray-600' }}"
    >
      {{ 'Menampilkan' if current_lang == 'id' else 'Showing' }}
      <span x-text="((currentPage - 1) * itemsPerPage) + 1"></span>
      -
      <span
        x-text="Math.min(currentPage * itemsPerPage, filteredPeserta.length)"
      ></span>
      {{ 'dari' if current_lang == 'id' else 'of' }}
      <span x-text="filteredPeserta.length"></span>
      {{ 'peserta' if current_lang == 'id' else 'participants' }}
    </span>
    <div class="flex gap-2">
      <button
        @click="currentPage = Math.max(1, currentPage - 1)"
        :disabled="currentPage === 1"
        :class="currentPage === 1 ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'"
        class="px-4 py-2 rounded-lg border {{ 'border-gray-600 bg-gray-700 text-white' if current_theme == 'dark' else 'border-gray-300 bg-white text-gray-900' }}"
      >
        {{ 'Sebelumnya' if current_lang == 'id' else 'Previous' }}
      </button>
      <button
        @click="currentPage = Math.min(totalPages, currentPage + 1)"
        :disabled="currentPage >= totalPages"
        :class="currentPage >= totalPages ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'"
        class="px-4 py-2 rounded-lg border {{ 'border-gray-600 bg-gray-700 text-white' if current_theme == 'dark' else 'border-gray-300 bg-white text-gray-900' }}"
      >
        {{ 'Berikutnya' if current_lang == 'id' else 'Next' }}
      </button>
    </div>
  </div>

  <!-- Modal Tambah/Edit Peserta -->
  <div
    x-show="showAddModal || showEditModal"
    x-transition
    class="fixed inset-0 z-50 flex items-center justify-center {{ 'bg-black/50' if current_theme == 'dark' else 'bg-gray-400/50' }} backdrop-blur-sm p-4 overflow-y-auto"
    @click.away="showAddModal = false; showEditModal = false"
  >
    <div
      @click.stop
      class="w-full max-w-4xl my-auto flex flex-col rounded-2xl shadow-2xl {{ 'bg-gray-800 text-white' if current_theme == 'dark' else 'bg-white text-gray-900' }} max-h-[90vh]"
    >
      <!-- Header - Fixed -->
      <div
        class="p-6 border-b {{ 'border-gray-700' if current_theme == 'dark' else 'border-gray-200' }} flex-shrink-0"
      >
        <div class="flex items-center justify-between">
          <h3 class="text-2xl font-bold">
            <span x-show="showAddModal"
              >{{ 'Tambah Peserta' if current_lang == 'id' else 'Add
              Participant' }}</span
            >
            <span x-show="showEditModal"
              >{{ 'Edit Peserta' if current_lang == 'id' else 'Edit Participant'
              }}</span
            >
          </h3>
          <button
            @click="showAddModal = false; showEditModal = false; selectedPeserta = null"
            class="text-2xl {{ 'text-gray-400 hover:text-white' if current_theme == 'dark' else 'text-gray-600 hover:text-gray-900' }}"
          >
            <i class="fa-solid fa-times"></i>
          </button>
        </div>
      </div>

      <!-- Form Content - Scrollable -->
      <form
        id="pesertaForm"
        @submit.prevent="savePeserta()"
        class="flex-1 overflow-y-auto p-6 space-y-6 min-h-0"
        x-show="selectedPeserta"
        style="max-height: calc(90vh - 180px)"
      >
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <input type="hidden" x-model="selectedPeserta.id" name="peserta_id" />

        <!-- Grid 2 Kolom -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Nama Lengkap -->
          <div>
            <label class="block font-semibold mb-2">
              {{ 'Nama Lengkap' if current_lang == 'id' else 'Full Name' }}
              <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              x-model="selectedPeserta.nama_lengkap"
              name="nama_lengkap"
              required
              class="w-full px-4 py-2.5 rounded-lg border {{ 'border-gray-600 bg-gray-700 text-white' if current_theme == 'dark' else 'border-gray-300 bg-white text-gray-900' }} focus:outline-none focus:ring-2 focus:ring-teal-400"
            />
          </div>

          <!-- Username -->
          <div>
            <label class="block font-semibold mb-2">
              {{ 'Username' if current_lang == 'id' else 'Username' }}
              <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              x-model="selectedPeserta.username"
              name="username"
              required
              class="w-full px-4 py-2.5 rounded-lg border {{ 'border-gray-600 bg-gray-700 text-white' if current_theme == 'dark' else 'border-gray-300 bg-white text-gray-900' }} focus:outline-none focus:ring-2 focus:ring-teal-400"
            />
          </div>

          <!-- Email -->
          <div>
            <label class="block font-semibold mb-2">
              {{ 'Email' if current_lang == 'id' else 'Email' }}
              <span class="text-red-500">*</span>
            </label>
            <input
              type="email"
              x-model="selectedPeserta.email"
              name="email"
              required
              class="w-full px-4 py-2.5 rounded-lg border {{ 'border-gray-600 bg-gray-700 text-white' if current_theme == 'dark' else 'border-gray-300 bg-white text-gray-900' }} focus:outline-none focus:ring-2 focus:ring-teal-400"
            />
          </div>

          <!-- Password (hanya untuk tambah) -->
          <div x-show="showAddModal">
            <label class="block font-semibold mb-2">
              {{ 'Password' if current_lang == 'id' else 'Password' }}
              <span class="text-red-500">*</span>
            </label>
            <input
              type="password"
              name="password"
              :required="showAddModal"
              class="w-full px-4 py-2.5 rounded-lg border {{ 'border-gray-600 bg-gray-700 text-white' if current_theme == 'dark' else 'border-gray-300 bg-white text-gray-900' }} focus:outline-none focus:ring-2 focus:ring-teal-400"
            />
          </div>

          <!-- Jenis Kelamin -->
          <div>
            <label class="block font-semibold mb-2">
              {{ 'Jenis Kelamin' if current_lang == 'id' else 'Gender' }}
              <span class="text-red-500">*</span>
            </label>
            <select
              x-model="selectedPeserta.jenis_kelamin"
              name="jenis_kelamin"
              required
              class="w-full px-4 py-2.5 rounded-lg border {{ 'border-gray-600 bg-gray-700 text-white' if current_theme == 'dark' else 'border-gray-300 bg-white text-gray-900' }} focus:outline-none focus:ring-2 focus:ring-teal-400"
            >
              <option value="">
                {{ '-- Pilih --' if current_lang == 'id' else '-- Select --' }}
              </option>
              <option value="laki-laki">
                {{ 'Laki-laki' if current_lang == 'id' else 'Male' }}
              </option>
              <option value="perempuan">
                {{ 'Perempuan' if current_lang == 'id' else 'Female' }}
              </option>
            </select>
          </div>

          <!-- Usia -->
          <div>
            <label class="block font-semibold mb-2">
              {{ 'Usia' if current_lang == 'id' else 'Age' }}
            </label>
            <input
              type="number"
              x-model="selectedPeserta.usia"
              name="usia"
              min="0"
              class="w-full px-4 py-2.5 rounded-lg border {{ 'border-gray-600 bg-gray-700 text-white' if current_theme == 'dark' else 'border-gray-300 bg-white text-gray-900' }} focus:outline-none focus:ring-2 focus:ring-teal-400"
            />
          </div>

          <!-- Nomor HP -->
          <div>
            <label class="block font-semibold mb-2">
              {{ 'Nomor HP' if current_lang == 'id' else 'Phone Number' }}
            </label>
            <input
              type="text"
              x-model="selectedPeserta.nomor_hp"
              name="nomor_hp"
              placeholder="081234567890"
              class="w-full px-4 py-2.5 rounded-lg border {{ 'border-gray-600 bg-gray-700 text-white placeholder-gray-400' if current_theme == 'dark' else 'border-gray-300 bg-white text-gray-900 placeholder-gray-500' }} focus:outline-none focus:ring-2 focus:ring-teal-400"
            />
          </div>

          <!-- Golongan -->
          <div>
            <label class="block font-semibold mb-2">
              {{ 'Golongan' if current_lang == 'id' else 'Group' }}
            </label>
            <select
              x-model="selectedPeserta.golongan"
              name="golongan"
              class="w-full px-4 py-2.5 rounded-lg border {{ 'border-gray-600 bg-gray-700 text-white' if current_theme == 'dark' else 'border-gray-300 bg-white text-gray-900' }} focus:outline-none focus:ring-2 focus:ring-teal-400"
            >
              <option value="">
                {{ '-- Pilih --' if current_lang == 'id' else '-- Select --' }}
              </option>
              <option value="siaga">Siaga</option>
              <option value="penggalang">Penggalang</option>
              <option value="penegak">Penegak</option>
              <option value="pandega">Pandega</option>
            </select>
          </div>

          <!-- Tingkatan -->
          <div>
            <label class="block font-semibold mb-2">
              {{ 'Tingkatan' if current_lang == 'id' else 'Level' }}
            </label>
            <select
              x-model="selectedPeserta.tingkatan"
              name="tingkatan"
              class="w-full px-4 py-2.5 rounded-lg border {{ 'border-gray-600 bg-gray-700 text-white' if current_theme == 'dark' else 'border-gray-300 bg-white text-gray-900' }} focus:outline-none focus:ring-2 focus:ring-teal-400"
            >
              <option value="">
                {{ '-- Pilih --' if current_lang == 'id' else '-- Select --' }}
              </option>
              <option value="siaga mula">Siaga Mula</option>
              <option value="siaga tata">Siaga Tata</option>
              <option value="siaga bantu">Siaga Bantu</option>
              <option value="siaga garuda">Siaga Garuda</option>
              <option value="penggalang ramu">Penggalang Ramu</option>
              <option value="penggalang rakit">Penggalang Rakit</option>
              <option value="penggalang terap">Penggalang Terap</option>
              <option value="penggalang garuda">Penggalang Garuda</option>
              <option value="penegak bantara">Penegak Bantara</option>
              <option value="penegak laksana">Penegak Laksana</option>
              <option value="penegak garuda">Penegak Garuda</option>
              <option value="pandega">Pandega</option>
              <option value="pandega garuda">Pandega Garuda</option>
            </select>
          </div>

          <!-- Tanggal Lahir -->
          <div>
            <label class="block font-semibold mb-2">
              {{ 'Tanggal Lahir' if current_lang == 'id' else 'Date of Birth' }}
            </label>
            <input
              type="date"
              x-model="selectedPeserta.tanggal_lahir"
              name="tanggal_lahir"
              class="w-full px-4 py-2.5 rounded-lg border {{ 'border-gray-600 bg-gray-700 text-white' if current_theme == 'dark' else 'border-gray-300 bg-white text-gray-900' }} focus:outline-none focus:ring-2 focus:ring-teal-400"
            />
          </div>

          <!-- Alamat Tinggal -->
          <div class="md:col-span-2">
            <label class="block font-semibold mb-2">
              {{ 'Alamat Tinggal' if current_lang == 'id' else 'Residence
              Address' }}
            </label>
            <textarea
              x-model="selectedPeserta.alamat_tinggal"
              name="alamat_tinggal"
              rows="2"
              class="w-full px-4 py-2.5 rounded-lg border {{ 'border-gray-600 bg-gray-700 text-white' if current_theme == 'dark' else 'border-gray-300 bg-white text-gray-900' }} focus:outline-none focus:ring-2 focus:ring-teal-400"
            ></textarea>
          </div>

          <!-- Asal Gudep -->
          <div>
            <label class="block font-semibold mb-2">
              {{ 'Asal Gudep' if current_lang == 'id' else 'Gudep Origin' }}
            </label>
            <input
              type="text"
              x-model="selectedPeserta.asal_gudep"
              name="asal_gudep"
              class="w-full px-4 py-2.5 rounded-lg border {{ 'border-gray-600 bg-gray-700 text-white' if current_theme == 'dark' else 'border-gray-300 bg-white text-gray-900' }} focus:outline-none focus:ring-2 focus:ring-teal-400"
            />
          </div>

          <!-- Asal Kwarran -->
          <div>
            <label class="block font-semibold mb-2">
              {{ 'Asal Kwarran' if current_lang == 'id' else 'Kwarran Origin' }}
            </label>
            <input
              type="text"
              x-model="selectedPeserta.asal_kwarran"
              name="asal_kwarran"
              class="w-full px-4 py-2.5 rounded-lg border {{ 'border-gray-600 bg-gray-700 text-white' if current_theme == 'dark' else 'border-gray-300 bg-white text-gray-900' }} focus:outline-none focus:ring-2 focus:ring-teal-400"
            />
          </div>

          <!-- Asal Kwarcab -->
          <div>
            <label class="block font-semibold mb-2">
              {{ 'Asal Kwarcab' if current_lang == 'id' else 'Kwarcab Origin' }}
            </label>
            <input
              type="text"
              x-model="selectedPeserta.asal_kwarcab"
              name="asal_kwarcab"
              class="w-full px-4 py-2.5 rounded-lg border {{ 'border-gray-600 bg-gray-700 text-white' if current_theme == 'dark' else 'border-gray-300 bg-white text-gray-900' }} focus:outline-none focus:ring-2 focus:ring-teal-400"
            />
          </div>

          <!-- Asal Kwarda -->
          <div>
            <label class="block font-semibold mb-2">
              {{ 'Asal Kwarda' if current_lang == 'id' else 'Kwarda Origin' }}
            </label>
            <input
              type="text"
              x-model="selectedPeserta.asal_kwarda"
              name="asal_kwarda"
              class="w-full px-4 py-2.5 rounded-lg border {{ 'border-gray-600 bg-gray-700 text-white' if current_theme == 'dark' else 'border-gray-300 bg-white text-gray-900' }} focus:outline-none focus:ring-2 focus:ring-teal-400"
            />
          </div>

          <!-- Status -->
          <div>
            <label class="block font-semibold mb-2">
              {{ 'Status Akun' if current_lang == 'id' else 'Account Status' }}
            </label>
            <select
              x-model="selectedPeserta.status"
              name="status"
              class="w-full px-4 py-2.5 rounded-lg border {{ 'border-gray-600 bg-gray-700 text-white' if current_theme == 'dark' else 'border-gray-300 bg-white text-gray-900' }} focus:outline-none focus:ring-2 focus:ring-teal-400"
            >
              <option value="aktif">
                {{ 'Aktif' if current_lang == 'id' else 'Active' }}
              </option>
              <option value="non-aktif">
                {{ 'Nonaktif' if current_lang == 'id' else 'Inactive' }}
              </option>
            </select>
          </div>
        </div>
      </form>

      <!-- Footer - Fixed -->
      <div
        class="p-6 border-t {{ 'border-gray-700' if current_theme == 'dark' else 'border-gray-200' }} flex-shrink-0 flex justify-end gap-4"
        x-show="selectedPeserta"
      >
        <button
          type="button"
          @click="showAddModal = false; showEditModal = false; selectedPeserta = null"
          class="px-6 py-2.5 rounded-lg font-medium cursor-pointer {{ 'bg-gray-600 hover:bg-gray-700 text-white' if current_theme == 'dark' else 'bg-gray-200 hover:bg-gray-300 text-gray-900' }} transition"
        >
          {{ 'Batal' if current_lang == 'id' else 'Cancel' }}
        </button>
        <button
          type="button"
          @click="savePeserta()"
          class="px-6 py-2.5 rounded-lg font-semibold cursor-pointer text-white bg-teal-600 hover:bg-teal-700 transition"
        >
          <i class="fa-solid fa-save mr-2"></i>
          {{ 'Simpan' if current_lang == 'id' else 'Save' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Konfirmasi Hapus -->
  <div
    x-show="showDeleteModal"
    x-transition
    class="fixed inset-0 z-50 flex items-center justify-center {{ 'bg-black/50' if current_theme == 'dark' else 'bg-gray-400/50' }} backdrop-blur-sm"
    @click.away="showDeleteModal = false"
  >
    <div
      @click.stop
      class="w-full max-w-md rounded-2xl shadow-2xl {{ 'bg-gray-800 text-white' if current_theme == 'dark' else 'bg-white text-gray-900' }} p-6 m-4"
    >
      <h3 class="text-xl font-bold mb-4">
        {{ 'Konfirmasi Hapus' if current_lang == 'id' else 'Confirm Delete' }}
      </h3>
      <p
        class="mb-6 {{ 'text-gray-300' if current_theme == 'dark' else 'text-gray-600' }}"
      >
        {{ 'Apakah Anda yakin ingin menghapus peserta' if current_lang == 'id'
        else 'Are you sure you want to delete participant' }}
        <strong x-text="selectedPeserta.nama_lengkap || ''"></strong>?
      </p>
      <div class="flex justify-end gap-4">
        <button
          @click="showDeleteModal = false; selectedPeserta = null"
          class="px-6 py-2.5 rounded-lg font-medium cursor-pointer {{ 'bg-gray-600 hover:bg-gray-700 text-white' if current_theme == 'dark' else 'bg-gray-200 hover:bg-gray-300 text-gray-900' }} transition"
        >
          {{ 'Batal' if current_lang == 'id' else 'Cancel' }}
        </button>
        <button
          @click="deletePeserta()"
          class="px-6 py-2.5 rounded-lg font-semibold cursor-pointer text-white bg-red-600 hover:bg-red-700 transition"
        >
          {{ 'Hapus' if current_lang == 'id' else 'Delete' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Notifikasi Toast -->
  <div
    x-data="{ notifications: [] }"
    x-init="window.showNotification = function(category, title, message) {
      const notification = { id: Date.now(), category, title, message, show: true };
      $data.notifications.push(notification);
      setTimeout(() => {
        notification.show = false;
        setTimeout(() => {
          $data.notifications = $data.notifications.filter(n => n.id !== notification.id);
        }, 300);
      }, 5000);
    }"
    class="fixed bottom-6 right-6 z-[60] space-y-3"
  >
    <template x-for="notification in notifications" :key="notification.id">
      <div
        x-show="notification.show"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 transform translate-x-full"
        x-transition:enter-end="opacity-100 transform translate-x-0"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100 transform translate-x-0"
        x-transition:leave-end="opacity-0 transform translate-x-full"
        class="flex items-center gap-3 px-6 py-4 rounded-2xl shadow-xl border min-w-[300px] max-w-md"
        :class="{
          'bg-green-600 text-white border-green-500': notification.category === 'success',
          'bg-red-600 text-white border-red-500': notification.category === 'danger' || notification.category === 'error',
          'bg-yellow-500 text-gray-900 border-yellow-400': notification.category === 'warning',
          'bg-gray-800 text-white border-gray-700': !['success', 'danger', 'error', 'warning'].includes(notification.category)
        }"
      >
        <i
          class="fa-solid text-lg"
          :class="{
            'fa-circle-check': notification.category === 'success',
            'fa-triangle-exclamation': notification.category === 'danger' || notification.category === 'error',
            'fa-exclamation-circle': notification.category === 'warning',
            'fa-info-circle': !['success', 'danger', 'error', 'warning'].includes(notification.category)
          }"
        ></i>
        <div class="flex-1">
          <strong x-text="notification.title"></strong><br />
          <span class="text-sm" x-text="notification.message"></span>
        </div>
        <button
          @click="notification.show = false; setTimeout(() => notifications = notifications.filter(n => n.id !== notification.id), 300)"
          class="ml-2 text-lg opacity-70 hover:opacity-100 transition-opacity"
        >
          <i class="fa-solid fa-times"></i>
        </button>
      </div>
    </template>
  </div>
</div>

<script>
  document.addEventListener("alpine:init", () => {
    Alpine.data("pesertaProfilData", () => ({
      pesertaList: [],
      filteredPeserta: [],
      searchQuery: "",
      filterGolongan: "",
      filterTingkatan: "",
      filterStatus: "",
      showAddModal: false,
      showEditModal: false,
      showDeleteModal: false,
      selectedPeserta: null,
      loading: false,
      currentPage: 1,
      itemsPerPage: 10,
      get paginatedPeserta() {
        const start = (this.currentPage - 1) * this.itemsPerPage;
        const end = start + this.itemsPerPage;
        return this.filteredPeserta.slice(start, end);
      },
      get totalPages() {
        return Math.ceil(this.filteredPeserta.length / this.itemsPerPage);
      },
      async loadPesertaList() {
        this.loading = true;
        try {
          const response = await fetch("/api/peserta/list", {
            headers: {
              "X-CSRFToken":
                document.querySelector('meta[name="csrf-token"]')?.content ||
                "",
            },
          });
          const data = await response.json();
          if (data.success) {
            this.pesertaList = data.peserta || [];
            this.filteredPeserta = data.peserta || [];
          }
        } catch (error) {
          console.error("Error:", error);
        } finally {
          this.loading = false;
        }
      },
      filterPeserta() {
        let filtered = [...this.pesertaList];

        if (this.searchQuery) {
          const query = this.searchQuery.toLowerCase();
          filtered = filtered.filter(
            (p) =>
              (p.nama_lengkap &&
                p.nama_lengkap.toLowerCase().includes(query)) ||
              (p.email && p.email.toLowerCase().includes(query)) ||
              (p.username && p.username.toLowerCase().includes(query))
          );
        }

        if (this.filterGolongan) {
          filtered = filtered.filter((p) => p.golongan === this.filterGolongan);
        }

        if (this.filterStatus) {
          filtered = filtered.filter((p) => p.status === this.filterStatus);
        }

        this.filteredPeserta = filtered;
        this.currentPage = 1;
      },
      editPeserta(peserta) {
        this.selectedPeserta = { ...peserta };
        this.showEditModal = true;
        this.showAddModal = false;
      },
      confirmDelete(peserta) {
        this.selectedPeserta = peserta;
        this.showDeleteModal = true;
      },
      async deletePeserta() {
        if (!this.selectedPeserta) return;

        try {
          const response = await fetch(
            `/api/peserta/delete/${this.selectedPeserta.id}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken":
                  document.querySelector('meta[name="csrf-token"]')?.content ||
                  "",
              },
            }
          );
          const result = await response.json();
          if (result.success) {
            const username =
              this.selectedPeserta.username ||
              this.selectedPeserta.nama_lengkap ||
              "";
            if (window.showNotification) {
              window.showNotification(
                "success",
                '{{ "Success" if current_lang == "id" else "Success" }}',
                `{{ "Peserta" if current_lang == "id" else "Participant" }} '${username}' {{ "berhasil dihapus" if current_lang == "id" else "deleted successfully" }}!`
              );
            }
            await this.loadPesertaList();
            this.showDeleteModal = false;
            this.selectedPeserta = null;
          } else {
            if (window.showNotification) {
              window.showNotification(
                "error",
                '{{ "Error" if current_lang == "id" else "Error" }}',
                result.message ||
                  '{{ "Gagal menghapus peserta" if current_lang == "id" else "Failed to delete participant" }}'
              );
            }
          }
        } catch (error) {
          console.error("Error:", error);
          if (window.showNotification) {
            window.showNotification(
              "error",
              '{{ "Error" if current_lang == "id" else "Error" }}',
              '{{ "Terjadi kesalahan saat menghapus peserta" if current_lang == "id" else "Error occurred while deleting participant" }}'
            );
          }
        }
      },
      async savePeserta() {
        if (!this.selectedPeserta) {
          if (window.showNotification) {
            window.showNotification(
              "error",
              '{{ "Error" if current_lang == "id" else "Error" }}',
              '{{ "Data peserta tidak ditemukan" if current_lang == "id" else "Participant data not found" }}'
            );
          }
          return;
        }

        // Cari form dengan ID atau di dalam modal
        let form = document.getElementById("pesertaForm");

        // Jika tidak ditemukan, cari form di dalam modal container
        if (!form) {
          const modalContainer = document.querySelector(".fixed.inset-0.z-50");
          if (modalContainer) {
            form = modalContainer.querySelector("form");
          }
        }

        // Jika masih tidak ditemukan, cari form secara global
        if (!form) {
          form = document.querySelector("form");
        }

        if (!form) {
          console.error("Form element not found");
          if (window.showNotification) {
            window.showNotification(
              "error",
              '{{ "Error" if current_lang == "id" else "Error" }}',
              '{{ "Form tidak ditemukan" if current_lang == "id" else "Form not found" }}'
            );
          }
          return;
        }

        const formData = new FormData(form);

        // Tambahkan data dari x-model ke FormData jika belum ada
        if (this.selectedPeserta.nama_lengkap)
          formData.set("nama_lengkap", this.selectedPeserta.nama_lengkap);
        if (this.selectedPeserta.username)
          formData.set("username", this.selectedPeserta.username);
        if (this.selectedPeserta.email)
          formData.set("email", this.selectedPeserta.email);
        if (this.selectedPeserta.jenis_kelamin)
          formData.set("jenis_kelamin", this.selectedPeserta.jenis_kelamin);
        if (this.selectedPeserta.usia)
          formData.set("usia", this.selectedPeserta.usia);
        if (this.selectedPeserta.nomor_hp)
          formData.set("nomor_hp", this.selectedPeserta.nomor_hp);
        if (this.selectedPeserta.golongan)
          formData.set("golongan", this.selectedPeserta.golongan);
        if (this.selectedPeserta.tingkatan)
          formData.set("tingkatan", this.selectedPeserta.tingkatan);
        if (this.selectedPeserta.tanggal_lahir)
          formData.set("tanggal_lahir", this.selectedPeserta.tanggal_lahir);
        if (this.selectedPeserta.alamat_tinggal)
          formData.set("alamat_tinggal", this.selectedPeserta.alamat_tinggal);
        if (this.selectedPeserta.asal_gudep)
          formData.set("asal_gudep", this.selectedPeserta.asal_gudep);
        if (this.selectedPeserta.asal_kwarran)
          formData.set("asal_kwarran", this.selectedPeserta.asal_kwarran);
        if (this.selectedPeserta.asal_kwarcab)
          formData.set("asal_kwarcab", this.selectedPeserta.asal_kwarcab);
        if (this.selectedPeserta.asal_kwarda)
          formData.set("asal_kwarda", this.selectedPeserta.asal_kwarda);
        if (this.selectedPeserta.status)
          formData.set("status", this.selectedPeserta.status);

        const url = this.showAddModal
          ? "/api/peserta/add"
          : `/api/peserta/edit/${this.selectedPeserta.id}`;

        try {
          const response = await fetch(url, {
            method: "POST",
            body: formData,
            headers: {
              "X-CSRFToken":
                document.querySelector('meta[name="csrf-token"]')?.content ||
                "",
            },
          });
          const result = await response.json();
          if (result.success) {
            const username =
              this.selectedPeserta.username ||
              this.selectedPeserta.nama_lengkap ||
              "";
            let message = "";

            if (this.showAddModal) {
              message = `{{ "Data peserta" if current_lang == "id" else "Participant data" }} '${username}' {{ "berhasil ditambahkan" if current_lang == "id" else "added successfully" }}!`;
            } else {
              message = `{{ "Data peserta" if current_lang == "id" else "Participant data" }} '${username}' {{ "berhasil diperbarui" if current_lang == "id" else "updated successfully" }}!`;
            }

            if (window.showNotification) {
              window.showNotification(
                "success",
                '{{ "Success" if current_lang == "id" else "Success" }}',
                message
              );
            }
            await this.loadPesertaList();
            this.showAddModal = false;
            this.showEditModal = false;
            this.selectedPeserta = null;
          } else {
            if (window.showNotification) {
              window.showNotification(
                "error",
                '{{ "Error" if current_lang == "id" else "Error" }}',
                result.message ||
                  '{{ "Gagal menyimpan data peserta" if current_lang == "id" else "Failed to save participant data" }}'
              );
            }
          }
        } catch (error) {
          console.error("Error:", error);
          if (window.showNotification) {
            window.showNotification(
              "error",
              '{{ "Error" if current_lang == "id" else "Error" }}',
              '{{ "Terjadi kesalahan saat menyimpan data" if current_lang == "id" else "Error occurred while saving data" }}'
            );
          }
        }
      },
    }));
  });
</script>
